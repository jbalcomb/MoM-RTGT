#include "MoMLevelBonuses.h"

#include <iostream>

#include "MoMGameBase.h"

namespace MoM {

const uint16_t gOffsetCodeSignature = 0x1D18;

const uint8_t gCodeSignature[] =
{
    0xE9, 0x84, 0x00,
};

const uint8_t gLevelBonusCode[] =
{
    0x55, 0x8B, 0xEC, 0x56, 0x57, 0x8B, 0x7E, 0x06,  0x8B, 0xC7, 0xB1, 0x05, 0xD3, 0xE0, 0xC4, 0x1E,
    0xC2, 0x9E, 0x03, 0xD8, 0x26, 0x8A, 0x47, 0x0C,  0x98, 0x8B, 0xF0, 0x8B, 0xC7, 0xB1, 0x05, 0xD3,
    0xE0, 0xC4, 0x1E, 0xC2, 0x9E, 0x03, 0xD8, 0x26,  0x8B, 0x47, 0x1A, 0x26, 0x8B, 0x57, 0x18, 0x83,
    0xE2, 0x00, 0x25, 0x00, 0x01, 0x0B, 0xD0, 0x75,  0x15, 0xC4, 0x5E, 0x08, 0x26, 0x8B, 0x47, 0x3C,
    0x26, 0x8B, 0x57, 0x3A, 0x83, 0xE2, 0x00, 0x25,  0x00, 0x01, 0x0B, 0xD0, 0x74, 0x08, 0x83, 0xFE,
    0x03, 0x7D, 0x03, 0xBE, 0x03, 0x00, 0x8B, 0xC7,  0xB1, 0x05, 0xD3, 0xE0, 0xC4, 0x1E, 0xC2, 0x9E,
    0x03, 0xD8, 0x26, 0x80, 0x7F, 0x06, 0xFF, 0xE9,  0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,  0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x00, 0x00,
    0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x02, 0x02,  0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x03, 0x03, 0x00, 0x00, 0x03, 0x02, 0x05, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE9, 0xC6,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,  0x01, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x00,
    0x00, 0x01, 0x01, 0x02, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x01,  0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x04, 0x04, 0x00, 0x00, 0x01, 0x02, 0x04,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05,
    0x05, 0x00, 0x00, 0x02, 0x03, 0x05, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x00,  0x00, 0x02, 0x03, 0x06, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x07, 0x07, 0x00, 0x00, 0x02,
    0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x08, 0x08, 0x00, 0x00, 0x03, 0x04, 0x08,  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F,  0x06, 0xBB, 0x1B, 0x1D, 0xEB, 0x04, 0x90, 0xBB,
    0xA2, 0x1D, 0x1E, 0x8B, 0xC6, 0xBA, 0x16, 0x00,  0xF7, 0xEA, 0x03, 0xD8, 0xC4, 0x7E, 0x08, 0x0E,
    0x1F, 0x8B, 0xF3, 0xFC, 0x33, 0xD2, 0x26, 0x8A,  0x1D, 0x80, 0xFB, 0x00, 0x77, 0x0A, 0x72, 0x0F,
    0x83, 0xFA, 0x04, 0x74, 0x03, 0xEB, 0x11, 0x90,  0xAC, 0x02, 0xC3, 0xAA, 0xEB, 0x0A, 0x90, 0xAC,
    0xF6, 0xD8, 0x02, 0xC3, 0xAA, 0xEB, 0x01, 0x90,  0x42, 0x83, 0xFA, 0x16, 0x7C, 0xD8, 0x1F, 0xE9,
    0xBB, 0x00,
};

bool MoMLevelBonuses::isCodeInstalled()
{
    uint8_t* ovl = m_game->getWizardsOverlay(116);
    if (0 == ovl)
        return false;
    uint8_t* codeSignature = &ovl[gOffsetCodeSignature];

    return (0 == memcmp(codeSignature, gCodeSignature, sizeof(gCodeSignature)));
}

bool MoMLevelBonuses::installCode()
{
    uint8_t* ovl = m_game->getWizardsOverlay(116);
    if (0 == ovl)
        return false;
    uint8_t* code = &ovl[0x1CB1];

    std::cout << "Install level bonus code in WIZARDS.EXE" << std::endl;
    bool ok = m_game->commitData(code, gLevelBonusCode, sizeof(gLevelBonusCode));
    if (ok)
    {
        std::cout << "Successfully installed level bonus code in WIZARDS.EXE" << std::endl;
    }
    else
    {
        std::cout << "Failed to install level bonus code in WIZARDS.EXE" << std::endl;
    }

    return ok;
}

}
